<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0D2137">
<title>QUOTE machine</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<!-- turf.js removed â€” replaced by custom geometry math in app.js -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/app.css">
<style>
/* â”€â”€ NEW 4-UNIT MEASUREMENT PANEL â”€â”€ */
#measurement-row {
  background: var(--surface2, #F4F7FA);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 14px;
  border: 2px solid transparent;
  transition: border-color 0.2s;
}
#measurement-row:focus-within {
  border-color: var(--accent, #E8A020);
}
.mrow-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.mrow-title {
  font-weight: 700;
  font-size: 13px;
  color: var(--navy, #0D2137);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.mrow-hint {
  font-size: 11px;
  color: var(--text2, #6B8FAD);
}
.mrow-units {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 8px;
}
.munit-box {
  background: white;
  border-radius: 8px;
  padding: 8px 8px 6px;
  border: 1.5px solid var(--border, #D8E4EF);
  transition: border-color 0.15s, background 0.15s;
}
.munit-box.has-value {
  border-color: var(--accent, #E8A020);
  background: #FFFBF0;
}
.munit-box:focus-within {
  border-color: var(--accent, #E8A020);
  box-shadow: 0 0 0 2px rgba(232,160,32,0.18);
}
.munit-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text2, #6B8FAD);
  margin-bottom: 4px;
  white-space: nowrap;
}
.munit-sub {
  font-weight: 400;
  font-size: 9px;
  text-transform: none;
  letter-spacing: 0;
}
.munit-input {
  width: 100%;
  font-size: 15px;
  font-weight: 700;
  font-family: 'DM Sans', sans-serif;
  color: var(--navy, #0D2137);
  border: none;
  background: transparent;
  outline: none;
  padding: 0;
  -moz-appearance: textfield;
}
.munit-input::-webkit-inner-spin-button,
.munit-input::-webkit-outer-spin-button { -webkit-appearance: none; }
.munit-input::placeholder { color: #C5D4E0; font-weight: 400; font-size: 13px; }
/* "â†“ use" indicator â€” only visible when box has a value */
.munit-use {
  display: none;
  color: var(--accent, #E8A020);
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 0;
  text-transform: none;
  vertical-align: middle;
}
.munit-box.has-value .munit-use {
  display: inline;
}
.munit-box.has-value .munit-label {
  cursor: pointer;
  -webkit-tap-highlight-color: rgba(232,160,32,0.2);
}
.munit-box.has-value .munit-label:active {
  color: var(--accent, #E8A020);
}
/* Selected state â€” the unit currently applied to line item */
.munit-box.selected {
  border-color: var(--accent, #E8A020) !important;
  background: #FFF8EC !important;
  box-shadow: 0 0 0 2px rgba(232,160,32,0.25);
}
.munit-box.selected .munit-label {
  color: var(--accent, #E8A020);
}
/* Pricing equivalents row */
.mrow-pricing {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border, #D8E4EF);
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
}
.mrow-pricing-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text2, #6B8FAD);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  width: 100%;
  margin-bottom: 2px;
}
.mrow-price-chip {
  background: #E8F4FF;
  color: var(--navy, #0D2137);
  font-size: 11px;
  font-weight: 600;
  border-radius: 20px;
  padding: 3px 10px;
  border: 1px solid #BDD8EF;
}
/* Saved quote measurement chips */
.qc-measurements {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin: 6px 0 4px;
}
.qcm-chip {
  background: var(--surface2, #F4F7FA);
  border: 1px solid var(--border, #D8E4EF);
  border-radius: 6px;
  font-size: 11px;
  color: var(--navy, #0D2137);
  padding: 3px 8px;
}
.qcm-chip strong {
  color: var(--accent, #E8A020);
}
@media (max-width: 380px) {
  .mrow-units { grid-template-columns: 1fr 1fr; }
}
/* â”€â”€ QUOTE ADDRESS AUTOCOMPLETE â”€â”€ */
.quote-addr-list {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 9999;
  background: white;
  border: 1.5px solid var(--accent, #E8A020);
  border-top: none;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  max-height: 220px;
  overflow-y: auto;
}
.quote-addr-list:empty { display: none; }
.quote-addr-list .autocomplete-item {
  padding: 11px 14px;
  font-size: 13px;
  color: var(--navy, #0D2137);
  border-bottom: 1px solid #EEF3F8;
  cursor: pointer;
  line-height: 1.3;
}
.quote-addr-list .autocomplete-item:last-child { border-bottom: none; }
.quote-addr-list .autocomplete-item:hover,
.quote-addr-list .autocomplete-item:active {
  background: #FFF8EC;
  color: var(--accent, #E8A020);
}
</style>
</head>
<body>

<!-- LOGIN GATE -->
<div id="login-gate">
  <div class="login-card">
    <div class="login-logo">QUOTE<span>machine</span></div>
    <div class="login-sub">Enter password to continue</div>
    <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
    <button id="login-btn">Sign In</button>
    <div id="login-error" class="login-error"></div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">QUOTE<span>machine</span></div>
  <div class="header-center" id="address-display"></div>
  <div class="header-actions">
    <button class="icon-btn" id="btn-saved-header" title="Saved Quotes">ğŸ“‹ <span id="saved-count">0</span></button>
    <button class="icon-btn" id="ai-chat-btn" title="AI Assistant">ğŸ¤–</button>
  </div>
</header>

<!-- MAP -->
<div id="map-container">
  <div id="map"></div>

  <!-- Search -->
  <div id="geocoder-wrapper">
    <div id="geocoder-inner">
      <input type="text" id="addr-input" placeholder="ğŸ”  Search job address..." autocomplete="off">
      <button id="search-btn">Go</button>
    </div>
    <div id="autocomplete-list"></div>
  </div>

  <!-- Draw toolbar â€” left side -->
  <div id="map-toolbar">
    <button class="map-tool-btn active" id="tool-draw" title="Draw Area">
      <span class="tool-icon">âœï¸</span>
      <span class="tool-label">Draw</span>
    </button>
    <button class="map-tool-btn" id="tool-line" title="Measure Distance">
      <span class="tool-icon">ğŸ“</span>
      <span class="tool-label">Line</span>
    </button>
    <button class="map-tool-btn" id="tool-clear" title="Clear Drawing">
      <span class="tool-icon">ğŸ—‘</span>
      <span class="tool-label">Clear</span>
    </button>
    <button class="map-tool-btn" id="tool-satellite" title="Toggle Labels">
      <span class="tool-icon">ğŸ—º</span>
      <span class="tool-label">Labels</span>
    </button>
    <button class="map-tool-btn" id="tool-streetview" title="Street View">
      <span class="tool-icon">ğŸ‘</span>
      <span class="tool-label">360Â°</span>
    </button>
  </div>

  <!-- Drawing mode overlay â€” shown while actively drawing -->
  <!-- Drawing mode bar â€” shown while drawing, clicks pass through to map -->
  <div id="drawing-overlay" style="display:none">
    <div id="drawing-instructions">
      <strong>Tap corners</strong> of the work area
    </div>
    <div id="point-counter">0 points</div>
    <button id="btn-done-drawing">âœ“ Done â€” Calculate Area</button>
    <div id="drawing-secondary-actions">
      <button id="btn-undo-point">â†© Undo</button>
      <button id="btn-cancel-drawing">âœ• Cancel</button>
    </div>
  </div>

  <!-- Measurement result badge -->
  <div id="measure-badge" style="display:none">
    <div class="badge-main">
      <span class="badge-val" id="badge-val">0</span>
      <span class="badge-unit" id="badge-unit">sq ft</span>
    </div>
    <button id="badge-clear-btn" class="badge-clear" title="Redraw">Redraw</button>
  </div>
</div>

<!-- QUOTE FORM PANEL -->
<div id="bottom-panel">
  <div class="panel-drag" id="panel-drag"><div class="drag-chevron" id="drag-chevron">â–²</div><div class="drag-bar"></div></div>
  <div class="panel-scroll" id="panel-scroll">

    <!-- View switcher -->
    <div class="tab-row">
      <button class="tab-btn active" id="tab-btn-quote">ğŸ“ New Quote</button>
      <button class="tab-btn" id="tab-btn-saved">ğŸ“‹ Saved (<span id="saved-count-tab">0</span>)</button>
      <button class="tab-btn" id="tab-btn-stats">ğŸ“Š Stats</button>
    </div>

    <!-- â•â•â• QUOTE TAB â•â•â• -->
    <div id="tab-quote">

      <!-- Measurement panel â€” all 4 units always visible and editable -->
      <div id="measurement-row">
        <div class="mrow-header">
          <span class="mrow-title" id="mrow-title">ğŸ“ Measurements</span>
          <span class="mrow-hint" id="mrow-hint">Draw on map or enter any value</span>
        </div>
        <div class="mrow-units">
          <div class="munit-box" id="munit-box-sqft">
            <div class="munit-label" onclick="selectMeasurementForItem('sqft')">Sq Ft <span class="munit-use">â†“ use</span></div>
            <input type="number" class="munit-input" id="munit-sqft" placeholder="0" min="0" step="1" oninput="onMeasurementInput('sqft', this.value)">
          </div>
          <div class="munit-box" id="munit-box-linft">
            <div class="munit-label" onclick="selectMeasurementForItem('linft')">Lin Ft <span class="munit-use">â†“ use</span></div>
            <input type="number" class="munit-input" id="munit-linft" placeholder="0" min="0" step="0.1" oninput="onMeasurementInput('linft', this.value)">
          </div>
          <div class="munit-box" id="munit-box-sqyd">
            <div class="munit-label" onclick="selectMeasurementForItem('sqyd')">Sq Yd <span class="munit-use">â†“ use</span></div>
            <input type="number" class="munit-input" id="munit-sqyd" placeholder="0" min="0" step="0.1" oninput="onMeasurementInput('sqyd', this.value)">
          </div>
          <div class="munit-box" id="munit-box-acre">
            <div class="munit-label" onclick="selectMeasurementForItem('acre')">Acres <span class="munit-use">â†“ use</span></div>
            <input type="number" class="munit-input" id="munit-acre" placeholder="0" min="0" step="0.0001" oninput="onMeasurementInput('acre', this.value)">
          </div>
        </div>
        <div class="mrow-pricing" id="mrow-pricing" style="display:none">
          <!-- filled by JS when a price is set -->
        </div>
      </div>
      <!-- Hidden legacy inputs for backward compat -->
      <select id="measure-type" style="display:none"><option value="sqft">Sq Ft</option><option value="linft">Lin Ft</option><option value="sqyd">Sq Yd</option><option value="acre">Acres</option></select>
      <input type="number" id="manual-area" style="display:none">

      <!-- Client info -->
      <div class="form-row">
        <div class="field" style="flex:1">
          <label>Client Name</label>
          <input type="text" id="client-name" placeholder="Name or company">
        </div>
      </div>
      <div class="form-row">
        <div class="field" style="flex:1">
          <label>Job Address</label>
          <div class="addr-field-row" style="position:relative">
            <input type="text" id="quote-address" placeholder="Enter or use map search ğŸ“" autocomplete="off">
            <button class="btn-addr-use" id="btn-use-map-addr" title="Use map address">ğŸ“</button>
            <div id="quote-addr-autocomplete" class="autocomplete-list quote-addr-list"></div>
          </div>
        </div>
      </div>

      <!-- â•â•â• LINE ITEMS â•â•â• -->
      <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
        <span>Line Items</span>
        <button class="btn-add-item" id="btn-add-item">+ Add Item</button>
      </div>
      <div id="line-items-container">
        <!-- line items render here -->
      </div>

      <!-- Markup -->
      <div class="form-row" style="margin-top:10px">
        <div class="field">
          <label>Markup %</label>
          <select id="markup">
            <option value="0">0%</option>
            <option value="1">1%</option>
            <option value="2">2%</option>
            <option value="3">3%</option>
            <option value="4">4%</option>
            <option value="5">5%</option>
            <option value="6">6%</option>
            <option value="7">7%</option>
            <option value="8">8%</option>
            <option value="9">9%</option>
            <option value="10">10%</option>
          </select>
        </div>
      </div>

      <!-- AI suggest price -->
      <button class="btn-ai-suggest" id="ai-suggest-btn">âœ¨ AI Suggest Price</button>

      <!-- TOTAL -->
      <div class="total-card">
        <div>
          <div class="total-label">Estimated Total</div>
          <div class="total-amount" id="total-display">$0.00</div>
          <div class="total-breakdown" id="breakdown-display">â€”</div>
        </div>
        <button class="btn-print-big" id="btn-print">ğŸ–¨ï¸ Print Quote</button>
      </div>

      <!-- Notes -->
      <div class="field" style="margin-top:12px">
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Conditions, special instructions, scope details..."></textarea>
      </div>

      <!-- AI Narrative section -->
      <div id="narrative-section" style="display:none">
        <div class="narrative-header">
          AI Scope of Work
          <button class="btn-text" id="btn-narrative-regen">â†º Regenerate</button>
        </div>
        <div id="narrative-text" class="narrative-box"></div>
      </div>

      <!-- Action row -->
      <div class="action-row">
        <button class="action-btn save" id="btn-save">ğŸ’¾ Save</button>
        <button class="action-btn narrative" id="btn-narrative">âœï¸ Narrative</button>
        <button class="action-btn share" id="btn-share">ğŸ“¤ Share</button>
      </div>
      <div class="action-row" style="margin-top:0">
        <button class="action-btn save" id="btn-pdf" style="background:var(--accent);color:var(--navy)">ğŸ“„ PDF</button>
        <button class="action-btn save" id="btn-pdf-plain" style="background:var(--surface2);color:var(--navy)">ğŸ“„ PDF (plain)</button>
      </div>
      <button class="btn-new-quote" id="btn-new">ï¼‹ Start New Quote</button>

    </div><!-- end tab-quote -->

    <!-- â•â•â• SAVED TAB â•â•â• -->
    <div id="tab-saved" style="display:none">
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="ğŸ”  Search by client, job type...">
        <button id="export-btn" class="btn-text-sm">Export</button>
      </div>
      <div id="saved-list"><div class="empty-state">No saved quotes yet.</div></div>
    </div>

    <!-- â•â•â• STATS TAB â•â•â• -->
    <div id="tab-stats" style="display:none">
      <div id="stats-content"><div class="empty-state">Loading...</div></div>
    </div>

  </div>
  <!-- â”€â”€ STICKY TOTAL â€” always visible at bottom of panel â”€â”€ -->
  <div class="sticky-total" id="sticky-total">
    <div class="sticky-total-left">
      <span class="sticky-total-label">Total</span>
    </div>
    <span class="sticky-total-val" id="sticky-total-val">$0.00</span>
  </div>
</div>

<!-- AI CHAT PANEL -->
<div id="ai-panel" class="side-panel">
  <div class="side-panel-header">
    <span>ğŸ¤– AI Assistant</span>
    <button id="ai-panel-close">âœ•</button>
  </div>
  <div id="chat-messages" class="chat-messages"></div>
  <div class="chat-input-row">
    <input type="text" id="chat-input" placeholder="Ask about pricing, measurements...">
    <button id="chat-send-btn">â¤</button>
  </div>
</div>
<div id="ai-overlay"></div>

<!-- SHARE MODAL -->
<div class="modal-overlay" id="share-modal">
  <div class="modal">
    <h3>Share Quote</h3>
    <div class="field" style="margin-bottom:12px">
      <textarea id="share-text" style="height:140px;font-size:13px;"></textarea>
    </div>
    <div class="modal-btns">
      <button class="m-btn cancel" id="share-cancel">Cancel</button>
      <button class="m-btn copy" id="share-copy">ğŸ“‹ Copy</button>
    </div>
    <div class="modal-btns" style="margin-top:8px">
      <button class="m-btn sms" id="share-sms">ğŸ’¬ Text</button>
      <button class="m-btn email" id="share-email">âœ‰ï¸ Email</button>
    </div>
  </div>
</div>

<!-- AI PRICE MODAL -->
<div class="modal-overlay" id="ai-price-modal">
  <div class="modal">
    <h3>âœ¨ AI Price Suggestion</h3>
    <div id="ai-price-content" class="ai-price-content"></div>
    <div class="modal-btns" style="margin-top:14px">
      <button class="m-btn cancel" id="ai-price-dismiss">Dismiss</button>
      <button class="m-btn copy" id="ai-price-apply">âœ“ Apply Recommended</button>
    </div>
  </div>
</div>

<!-- PULL TO REFRESH -->
<div id="ptr-indicator">
  <div class="ptr-spinner">â†»</div>
  <span>Release to refresh</span>
</div>

<!-- INSTALL BANNER -->
<div id="install-banner" class="install-banner" style="display:none">
  <div class="install-inner">
    <span>ğŸ“² Install <strong>QUOTE machine</strong> for quick access</span>
    <div class="install-btns">
      <button id="install-btn">Install</button>
      <button id="install-dismiss" class="dismiss">Later</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script src="/js/app.js"></script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// KEYBOARD JUMP PREVENTION
// iOS and Android resize the viewport when the keyboard opens.
// This causes dvh/vh layouts to reflow, making the map and 
// panel jump. We lock the document height to the initial
// window.innerHeight the moment any input gains focus.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  var lockedH = null;

  function lockHeight() {
    if (lockedH !== null) return;
    lockedH = window.innerHeight;
    document.documentElement.style.setProperty('height', lockedH + 'px', 'important');
    document.body.style.setProperty('height', lockedH + 'px', 'important');
  }

  function unlockHeight() {
    // Only unlock if no input is still focused
    if (document.activeElement && document.activeElement.matches('input,textarea,select')) return;
    lockedH = null;
    document.documentElement.style.removeProperty('height');
    document.body.style.removeProperty('height');
  }

  document.addEventListener('focusin', function(e) {
    if (e.target.matches('input,textarea,select')) {
      // Short delay so browser doesn't fight us during keyboard animation
      setTimeout(lockHeight, 50);
    }
  }, true);

  document.addEventListener('focusout', function() {
    setTimeout(unlockHeight, 150);
  }, true);
})();
</script>
</body>
</html>
