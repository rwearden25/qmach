<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0D2137">
<title>QUOTE machine</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/app.css">
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN GATE ‚ïê‚ïê‚ïê -->
<div id="login-gate">
  <div class="login-card">
    <div class="login-logo">QUOTE<span>machine</span></div>
    <div class="login-sub">Enter password to continue</div>
    <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
    <button id="login-btn">Sign In</button>
    <div id="login-error" class="login-error"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
  <div class="logo">Q<span>M</span></div>
  <div class="header-center" id="address-display"></div>
  <div class="header-right">
    <span class="user-badge" id="user-badge" style="display:none"></span>
    <button class="hdr-btn" id="btn-saved-header" aria-label="Saved quotes"><span class="hdr-count" id="saved-count">0</span> Saved</button>
    <button class="hdr-btn hdr-menu-btn" id="hdr-menu-toggle" aria-label="Menu">‚ò∞</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê HEADER DROPDOWN MENU (secondary actions) ‚ïê‚ïê‚ïê -->
<div id="hdr-menu" class="hdr-menu">
  <button class="hdr-menu-item" id="ai-chat-btn">ü§ñ AI Assistant</button>
  <button class="hdr-menu-item" id="tab-btn-stats">üìä Stats Dashboard</button>
  <button class="hdr-menu-item" id="export-btn">üì• Export All Quotes</button>
  <button class="hdr-menu-item" id="btn-logout">‚Ü© Sign Out</button>
</div>

<!-- ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê -->
<div id="map-container">
  <div id="map"></div>

  <!-- Search -->
  <div id="geocoder-wrapper">
    <div id="geocoder-inner">
      <input type="text" id="addr-input" placeholder="Search job address..." autocomplete="off">
      <button id="search-btn" aria-label="Search address">Go</button>
    </div>
    <div id="autocomplete-list"></div>
  </div>

  <!-- Map tools ‚Äî floating right edge -->
  <div id="map-toolbar">
    <button class="map-tool-btn active" id="tool-draw" aria-label="Draw area on map">
      <span class="tool-icon">‚úèÔ∏è</span>
      <span class="tool-tip">Draw Area</span>
    </button>
    <button class="map-tool-btn" id="tool-line" aria-label="Measure a line">
      <span class="tool-icon">üìè</span>
      <span class="tool-tip">Line</span>
    </button>
    <button class="map-tool-btn" id="tool-clear" aria-label="Clear drawing">
      <span class="tool-icon">üóë</span>
      <span class="tool-tip">Clear</span>
    </button>
    <button class="map-tool-btn" id="tool-satellite" aria-label="Toggle map labels">
      <span class="tool-icon">üó∫</span>
      <span class="tool-tip">Labels</span>
    </button>
    <button class="map-tool-btn" id="tool-streetview" aria-label="Open street view">
      <span class="tool-icon">üëÅ</span>
      <span class="tool-tip">Street</span>
    </button>
  </div>

  <!-- Drawing mode overlay -->
  <div id="drawing-overlay" style="display:none">
    <div id="drawing-instructions"><strong>Tap corners</strong> of the work area</div>
    <div id="point-counter">0 points</div>
    <button id="btn-done-drawing">‚úì Done ‚Äî Calculate</button>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="btn-undo-point" style="pointer-events:all;background:rgba(13,33,55,.7);color:rgba(255,255,255,.7);border:none;font-size:13px;cursor:pointer;padding:6px 14px;border-radius:12px;font-family:inherit" disabled>‚Ü© Undo</button>
      <button id="btn-cancel-drawing">‚úï Cancel</button>
    </div>
  </div>

  <!-- Measurement badge -->
  <div id="measure-badge" style="display:none">
    <div class="badge-main">
      <span class="badge-val" id="badge-val">0</span>
      <span class="badge-unit" id="badge-unit">sq ft</span>
    </div>
    <button id="badge-clear-btn" class="badge-clear">Redraw</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BOTTOM PANEL ‚ïê‚ïê‚ïê -->
<div id="bottom-panel">
  <div class="panel-drag" id="panel-drag">
    <div class="drag-chevron" id="drag-chevron">‚ñ≤</div>
    <div class="drag-bar"></div>
  </div>
  <div class="panel-scroll" id="panel-scroll">

    <!-- Two clean tabs -->
    <div class="tab-row">
      <button class="tab-btn active" id="tab-btn-quote">New Quote</button>
      <button class="tab-btn" id="tab-btn-saved">Saved <span id="saved-count-tab">0</span></button>
    </div>

    <!-- ‚ïê‚ïê‚ïê QUOTE TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-quote">

      <!-- STEP 1: Measurements ‚Äî compact read grid -->
      <div id="measurement-row" class="card">
        <div class="card-header">
          <span class="card-title" id="mrow-title">Measurements</span>
          <span class="card-hint" id="mrow-hint">Draw on map or type below</span>
        </div>
        <div class="mrow-units">
          <div class="munit-box" id="munit-box-sqft">
            <label class="munit-label" for="munit-sqft">Sq Ft</label>
            <input type="number" class="munit-input" id="munit-sqft" placeholder="‚Äî" min="0" step="1">
          </div>
          <div class="munit-box" id="munit-box-linft">
            <label class="munit-label" for="munit-linft">Lin Ft</label>
            <input type="number" class="munit-input" id="munit-linft" placeholder="‚Äî" min="0" step="0.1">
          </div>
          <div class="munit-box" id="munit-box-sqyd">
            <label class="munit-label" for="munit-sqyd">Sq Yd</label>
            <input type="number" class="munit-input" id="munit-sqyd" placeholder="‚Äî" min="0" step="0.1">
          </div>
          <div class="munit-box" id="munit-box-acre">
            <label class="munit-label" for="munit-acre">Acres</label>
            <input type="number" class="munit-input" id="munit-acre" placeholder="‚Äî" min="0" step="0.0001">
          </div>
        </div>
        <div class="mrow-pricing" id="mrow-pricing" style="display:none"></div>
      </div>
      <!-- Hidden legacy inputs -->
      <select id="measure-type" style="display:none"><option value="sqft">Sq Ft</option></select>
      <input type="number" id="manual-area" style="display:none">

      <!-- STEP 2: Client & Address -->
      <div class="card">
        <div class="form-field">
          <label for="client-name">Client Name</label>
          <input type="text" id="client-name" placeholder="Who is this quote for?">
        </div>
        <div class="form-field">
          <label for="quote-address">Job Address</label>
          <div class="input-with-btn">
            <input type="text" id="quote-address" placeholder="Type or use map search" autocomplete="off">
            <button class="input-action-btn" id="btn-use-map-addr" aria-label="Use address from map">üìç</button>
          </div>
          <div id="quote-addr-autocomplete" class="autocomplete-list quote-addr-list"></div>
        </div>
      </div>

      <!-- STEP 3: Line Items (starts with 1, clean) -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Job Details</span>
          <button class="link-btn" id="btn-add-item">+ Add Item</button>
        </div>
        <div id="line-items-container"></div>
      </div>

      <!-- STEP 4: Total + Actions -->
      <div class="total-card">
        <div class="total-top">
          <div class="total-label">Estimated Total</div>
          <div class="total-amount" id="total-display">$0.00</div>
          <div class="total-sub" id="breakdown-display">‚Äî</div>
        </div>
        <div class="total-actions">
          <button class="btn-primary" id="btn-save">Save Quote</button>
          <button class="btn-secondary" id="btn-share">Send to Client</button>
        </div>
      </div>

      <!-- MORE OPTIONS (collapsed by default) -->
      <details class="more-options">
        <summary>More Options</summary>
        <div class="more-content">
          <div class="form-field">
            <label for="markup">Markup %</label>
            <select id="markup">
              <option value="0">0% ‚Äî No markup</option>
              <option value="1">1%</option><option value="2">2%</option>
              <option value="3">3%</option><option value="4">4%</option>
              <option value="5">5%</option><option value="6">6%</option>
              <option value="7">7%</option><option value="8">8%</option>
              <option value="9">9%</option><option value="10">10%</option>
            </select>
          </div>
          <div class="form-field">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Special instructions, scope details..."></textarea>
          </div>
          <button class="btn-outline" id="ai-suggest-btn">‚ú® AI Suggest Price</button>
          <button class="btn-outline" id="btn-narrative">‚úçÔ∏è Generate Scope of Work</button>
          <button class="btn-outline" id="btn-print">üñ®Ô∏è Print / PDF</button>
          <div class="pdf-row">
            <button class="btn-outline small" id="btn-pdf">PDF (Branded)</button>
            <button class="btn-outline small" id="btn-pdf-plain">PDF (Plain)</button>
          </div>
          <div id="narrative-section" style="display:none">
            <div class="card-header" style="margin-top:10px">
              <span class="card-title">AI Scope of Work</span>
              <button class="link-btn" id="btn-narrative-regen">‚Ü∫ Redo</button>
            </div>
            <div id="narrative-text" class="narrative-box"></div>
          </div>
        </div>
      </details>

      <button class="btn-new-quote" id="btn-new">+ Start New Quote</button>

    </div><!-- /tab-quote -->

    <!-- ‚ïê‚ïê‚ïê SAVED TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-saved" style="display:none">
      <div class="form-field">
        <input type="text" id="search-input" placeholder="Search by client, job type...">
      </div>
      <div id="saved-list"><div class="empty-state">No saved quotes yet.</div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STATS TAB (hidden on mobile, accessed via menu) ‚ïê‚ïê‚ïê -->
    <div id="tab-stats" style="display:none">
      <div id="stats-content"><div class="empty-state">Loading...</div></div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STICKY TOTAL BAR (shows when scrolled past total) ‚ïê‚ïê‚ïê -->
<div id="sticky-total" class="sticky-total" style="display:none">
  <div class="sticky-amount" id="sticky-total-val">$0.00</div>
  <button class="sticky-save" id="sticky-save-btn">Save</button>
</div>

<!-- ‚ïê‚ïê‚ïê AI CHAT PANEL ‚ïê‚ïê‚ïê -->
<div id="ai-panel" class="side-panel">
  <div class="side-panel-header">
    <span>AI Assistant</span>
    <button id="ai-panel-close">‚úï</button>
  </div>
  <div id="chat-messages" class="chat-messages"></div>
  <div class="chat-input-row">
    <input type="text" id="chat-input" placeholder="Ask about pricing...">
    <button id="chat-send-btn">‚û§</button>
  </div>
</div>
<div id="ai-overlay"></div>

<!-- ‚ïê‚ïê‚ïê SHARE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="share-modal">
  <div class="modal">
    <h3>Send Quote</h3>
    <div class="form-field">
      <textarea id="share-text" rows="6"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-outline" id="share-cancel">Cancel</button>
      <button class="btn-primary" id="share-copy">üìã Copy</button>
    </div>
    <div class="modal-actions" style="margin-top:8px">
      <button class="btn-primary" id="share-sms" style="background:#27AE60">üí¨ Text</button>
      <button class="btn-primary" id="share-email" style="background:#6B9AC4">‚úâÔ∏è Email</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê AI PRICE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="ai-price-modal">
  <div class="modal">
    <h3>AI Price Suggestion</h3>
    <div id="ai-price-content"></div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="btn-outline" id="ai-price-dismiss">Dismiss</button>
      <button class="btn-primary" id="ai-price-apply">Apply Recommended</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PULL TO REFRESH ‚ïê‚ïê‚ïê -->
<div id="ptr-indicator"><div class="ptr-spinner">‚Üª</div><span>Release to refresh</span></div>

<!-- ‚ïê‚ïê‚ïê INSTALL BANNER ‚ïê‚ïê‚ïê -->
<div id="install-banner" class="install-banner" style="display:none">
  <div class="install-inner">
    <span>Install <strong>QUOTE machine</strong></span>
    <div class="install-btns">
      <button id="install-btn">Install</button>
      <button id="install-dismiss" class="dismiss">Later</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê -->
<div id="toast"></div>

<script src="/js/app.js"></script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// ‚îÄ‚îÄ Header menu toggle
(function() {
  const btn = document.getElementById('hdr-menu-toggle');
  const menu = document.getElementById('hdr-menu');
  if (!btn || !menu) return;
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    menu.classList.toggle('open');
  });
  document.addEventListener('click', function() {
    menu.classList.remove('open');
  });
  // Close menu when any item is clicked
  menu.querySelectorAll('.hdr-menu-item').forEach(function(item) {
    item.addEventListener('click', function() { menu.classList.remove('open'); });
  });
})();

// ‚îÄ‚îÄ Measurement input wiring (replaces inline oninput)
['sqft','linft','sqyd','acre'].forEach(function(unit) {
  var el = document.getElementById('munit-' + unit);
  if (el) el.addEventListener('input', function() {
    if (typeof onMeasurementInput === 'function') onMeasurementInput(unit, this.value);
  });
});

// ‚îÄ‚îÄ Keyboard jump prevention
(function() {
  var lockedH = null;
  function lockHeight() {
    if (lockedH !== null) return;
    lockedH = window.innerHeight;
    document.documentElement.style.setProperty('height', lockedH + 'px', 'important');
    document.body.style.setProperty('height', lockedH + 'px', 'important');
  }
  function unlockHeight() {
    if (document.activeElement && document.activeElement.matches('input,textarea,select')) return;
    lockedH = null;
    document.documentElement.style.removeProperty('height');
    document.body.style.removeProperty('height');
  }
  document.addEventListener('focusin', function(e) {
    if (e.target.matches('input,textarea,select')) setTimeout(lockHeight, 50);
  }, true);
  document.addEventListener('focusout', function() {
    setTimeout(unlockHeight, 150);
  }, true);
})();

// ‚îÄ‚îÄ Long-press tooltip for mobile tool buttons
(function() {
  var tipEl = null;
  var timer = null;
  document.querySelectorAll('[aria-label]').forEach(function(btn) {
    btn.addEventListener('touchstart', function(e) {
      var label = btn.getAttribute('aria-label');
      if (!label) return;
      timer = setTimeout(function() {
        if (tipEl) tipEl.remove();
        tipEl = document.createElement('div');
        tipEl.className = 'touch-tooltip';
        tipEl.textContent = label;
        var rect = btn.getBoundingClientRect();
        tipEl.style.top = (rect.top - 36) + 'px';
        tipEl.style.left = (rect.left + rect.width/2) + 'px';
        document.body.appendChild(tipEl);
        setTimeout(function() { if (tipEl) tipEl.remove(); }, 2000);
      }, 500);
    }, {passive: true});
    btn.addEventListener('touchend', function() { clearTimeout(timer); });
    btn.addEventListener('touchcancel', function() { clearTimeout(timer); });
  });
})();
</script>
</body>
</html>
